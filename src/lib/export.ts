import fs from 'fs/promises';
import path from 'path';
import AdmZip from 'adm-zip';
import { getProject } from './projects';
import { getTrainingSet } from './dataset';

export async function createExportZip(projectId: string): Promise<Buffer> {
    const project = await getProject(projectId);
    if (!project) throw new Error('Project not found');

    const { items, stats } = await getTrainingSet(projectId);
    const zip = new AdmZip();

    // Add images and captions
    for (const item of items) {
        try {
            // Add Image
            const imgContent = await fs.readFile(item.imagePath);
            const imgExt = path.extname(item.imagePath) || '.png';
            zip.addFile(`dataset/${item.fileName}${imgExt}`, imgContent);

            // Add Caption (if exists)
            const capExists = await fs.access(item.captionPath).then(() => true).catch(() => false);
            if (capExists) {
                const capContent = await fs.readFile(item.captionPath);
                zip.addFile(`dataset/${item.fileName}.txt`, capContent);
            }
        } catch (e) {
            console.error(`Error adding item ${item.id} to zip`, e);
        }
    }

    // Add README
    const readmeContent = `
# Dataset: ${project.name}

Generated by LoRA Bento.

## Stats
- Total Images: ${stats.total}
- Raw Images: ${stats.raw}
- Augmented Images: ${stats.aug}
- Excluded Images: ${stats.excluded}

## Configuration
- Target Size: ${project.settings.targetSize}
- Trigger Word: ${project.settings.triggerWord || 'None'}
- Caption Model: ${project.settings.captionModel || 'Manual/Imported'}

## Suggested Prompts
${project.settings.triggerWord ? `1. ${project.settings.triggerWord}, ...` : '1. ...'}
  `.trim();

    zip.addFile('README.md', Buffer.from(readmeContent, 'utf-8'));

    // Add metadata.json (Kohya format)
    // Re-generate specific metadata.json for Kohya if needed (image path keys)
    // For now standard is usually text files side-by-side or a metadata.json
    // We'll stick to text files side-by-side as it's most compatible.

    return zip.toBuffer();
}
